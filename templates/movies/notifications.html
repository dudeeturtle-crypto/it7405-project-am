{% extends 'base.html' %}

{% block title %}Notifications{% endblock %}

{% block content %}
<div class="mt-6">
  <h1 class="text-3xl font-bold mb-2">Notifications</h1>
  <p class="text-slate-600 mb-6">Stay updated on new reviews for your favorited movies</p>

  {% if page_obj.paginator.count > 0 %}
    <div class="mb-4 p-3 rounded bg-blue-50 border border-blue-200 text-blue-800">
      You have <strong>{{ unread_count }}</strong> unread notification(s) out of <strong>{{ total_count }}</strong> total.
    </div>

    <div class="space-y-4">
      {% for notification in page_obj %}
        <div class="border rounded p-4 {% if not notification.is_read %}bg-yellow-50 border-yellow-200{% else %}bg-white{% endif %}">
          <div class="flex items-start justify-between">
            <div class="flex-1">
              {% if notification.notification_type == 'support_response' %}
                <!-- Support Response Notification -->
                <h3 class="text-lg font-semibold text-slate-900">{{ notification.title }}</h3>
                <p class="text-sm text-slate-600 mt-1">
                  <strong>Message:</strong> {{ notification.message }}
                </p>
                <p class="text-xs text-slate-500 mt-2">
                  {{ notification.created_at|date:"M d, Y H:i" }}
                </p>
              {% else %}
                <!-- Review Notification -->
                <h3 class="text-lg font-semibold text-slate-900">
                  <a href="{% url 'movies:movie_detail' notification.movie_slug %}" class="text-indigo-600 hover:underline">
                    {{ notification.movie_title }}
                  </a>
                </h3>
                <p class="text-sm text-slate-600 mt-1">
                  <strong>New High-Rated Review:</strong> "{{ notification.review_title }}"
                </p>
                <p class="text-sm text-slate-600">
                  ‚≠ê Rating: <strong>{{ notification.review_rating }}</strong> / 5
                </p>
                <p class="text-xs text-slate-500 mt-2">
                  {{ notification.created_at|date:"M d, Y H:i" }}
                </p>
              {% endif %}
            </div>
            <div>
              {% if not notification.is_read %}
                {% if notification.notification_type == 'support_response' %}
                  <button class="px-3 py-1 text-sm bg-indigo-600 text-white rounded hover:bg-indigo-700" onclick="markAsRead('', '{{ notification.ticket_subject }}')">
                    Mark as Read
                  </button>
                {% else %}
                  <button class="px-3 py-1 text-sm bg-indigo-600 text-white rounded hover:bg-indigo-700" onclick="markAsRead('{{ notification.movie_slug }}', '')">
                    Mark as Read
                  </button>
                {% endif %}
              {% else %}
                <span class="text-xs text-slate-500">Read</span>
              {% endif %}
            </div>
          </div>
        </div>
      {% endfor %}
    </div>

    <!-- Pagination -->
    {% if page_obj.has_other_pages %}
      <div class="mt-8 flex justify-center gap-4">
        {% if page_obj.has_previous %}
          <a href="?page=1" class="px-4 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300">First</a>
          <a href="?page={{ page_obj.previous_page_number }}" class="px-4 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300">Previous</a>
        {% endif %}

        <span class="px-4 py-2 text-slate-700">
          Page <strong>{{ page_obj.number }}</strong> of <strong>{{ page_obj.paginator.num_pages }}</strong>
        </span>

        {% if page_obj.has_next %}
          <a href="?page={{ page_obj.next_page_number }}" class="px-4 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300">Next</a>
          <a href="?page={{ page_obj.paginator.num_pages }}" class="px-4 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300">Last</a>
        {% endif %}
      </div>
    {% endif %}

  {% else %}
    <div class="bg-slate-50 border border-slate-200 rounded p-6 text-center">
      <p class="text-slate-700 mb-4">You don't have any notifications yet.</p>
      <p class="text-slate-600 mb-6">When someone posts a highly-rated review (4.5+ stars) for a movie in your watchlist, you'll get notified here.</p>
      <a href="{% url 'movies:watchlist' %}" class="inline-block px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">
        View My Watchlist
      </a>
    </div>
  {% endif %}
</div>

<script>
  function markAsRead(movieSlug, ticketSubject) {
    const formData = new FormData();
    if (ticketSubject) {
      formData.append('ticket_subject', ticketSubject);
    }
    
    const url = movieSlug 
      ? `/api/notifications/${movieSlug}/read/` 
      : `/api/notifications/support/read/`;
    
    fetch(url, {
      method: 'POST',
      headers: {
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || '',
        'X-Requested-With': 'XMLHttpRequest',
      },
      body: formData
    })
    .then(response => response.json())
    .then(data => {
      if (data.status === 'ok') {
        // Reload the page to update notification status
        window.location.reload();
      } else {
        alert('Error: ' + (data.message || 'Unknown error'));
      }
    })
    .catch(err => {
      console.error('Error:', err);
      alert('Failed to mark notification as read');
    });
  }
</script>

{% endblock %}
