{% extends 'base.html' %}

{% block title %}Add Movie Review{% endblock %}

{% block content %}
<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-6">
  {% if movie %}
  <div class="md:col-span-1">
    {% if movie.photo_url %}
      <img src="{{ movie.photo_url }}" alt="{{ movie.title }}" class="w-full h-auto rounded shadow">
    {% elif movie.poster_url %}
      <img src="{{ movie.poster_url }}" alt="{{ movie.title }}" class="w-full h-auto rounded shadow">
    {% else %}
      <img src="https://via.placeholder.com/400x600?text=No+Image" alt="No image" class="w-full h-auto rounded shadow">
    {% endif %}
  </div>
  <div class="md:col-span-2">
    <h1 class="text-3xl font-bold">{{ movie.title }} <span class="text-slate-500 text-base">({{ movie.year }})</span></h1>
    
    <!-- Favorite/Watchlist Button -->
    {% if user.is_authenticated or request.session.username %}
      <button id="favorite-btn" class="mt-3 px-4 py-2 rounded transition {% if is_favorited %}bg-red-500 text-white hover:bg-red-600{% else %}bg-gray-300 text-gray-800 hover:bg-gray-400{% endif %}" onclick="toggleFavorite('{{ movie.slug }}')">
        <span id="favorite-icon">{% if is_favorited %}[LOVED]{% else %}[LOVE]{% endif %}</span>
        <span id="favorite-text">{% if is_favorited %}Remove from Watchlist{% else %}Add to Watchlist{% endif %}</span>
      </button>
    {% else %}
      <p class="mt-3 text-sm text-slate-600"><a href="{% url 'accounts:login' %}" class="text-blue-600 hover:underline">Log in</a> to add this movie to your watchlist.</p>
    {% endif %}

    <p class="mt-2 text-slate-600">{{ movie.description }}</p>
    <div class="mt-4 text-sm text-slate-700">
      <div><strong>Director:</strong> {{ movie.director }}</div>
      <div><strong>Cast:</strong> {% if movie.cast %}{{ movie.cast|join:", " }}{% else %}N/A{% endif %}</div>
    </div>
  </div>
  {% endif %}
</div>

<div class="mt-8 grid grid-cols-1 md:grid-cols-3 gap-6">
  <div class="md:col-span-2">
    <h3 class="text-xl font-semibold mb-3">Reviews</h3>
    <div id="reviews-list">
    {% for review in reviews %}
      <div class="border rounded p-4 mb-3">
        <div class="flex items-center justify-between mb-2">
          <div>
            <h4 class="font-medium">{{ review.title|default:"Untitled" }}</h4>
            <p class="text-xs text-slate-500">by {{ review.user }}</p>
          </div>
          <div class="text-sm text-slate-600">⭐ {{ review.rating }}</div>
        </div>
        <p class="text-slate-700 mt-2">{{ review.body }}</p>
      </div>
    {% empty %}
      <p class="text-slate-500" id="no-reviews">No reviews yet.</p>
    {% endfor %}
    </div>
  </div>

  <div class="md:col-span-1">
    <h3 class="text-lg font-semibold mb-3">Write a Review</h3>
    {% if mongo_is_authenticated %}
    <form id="review-form" method="POST">
      {% csrf_token %}
      <div id="review-status" class="mb-3" style="display:none"></div>
      <div class="mb-3">
        <label class="block text-sm text-slate-700">Title</label>
        <input name="title" class="w-full px-3 py-2 border rounded" required />
      </div>
      <div class="mb-3">
        <label class="block text-sm text-slate-700">Rating</label>
        <input name="rating" type="number" min="1" max="5" class="w-full px-3 py-2 border rounded" required />
      </div>
      <div class="mb-3">
        <label class="block text-sm text-slate-700">Review</label>
        <textarea name="body" rows="5" class="w-full px-3 py-2 border rounded" required></textarea>
      </div>
      <button type="submit" id="review-submit" class="w-full px-4 py-2 bg-indigo-600 text-white rounded">Submit Review</button>
    </form>
    <script>
      (function(){
        const form = document.getElementById('review-form');
        if(!form) return;
        const statusEl = document.getElementById('review-status');
        const reviewsList = document.getElementById('reviews-list');
        const noReviewsEl = document.getElementById('no-reviews');

        form.addEventListener('submit', async function(e){
          e.preventDefault();
          statusEl.style.display = 'none';
          const submitBtn = document.getElementById('review-submit');
          submitBtn.disabled = true;
          submitBtn.classList.add('opacity-70');

          const data = new FormData(form);
          try{
            const resp = await fetch(window.location.pathname, {
              method: 'POST',
              body: data,
              credentials: 'same-origin',
              headers: {
                'X-Requested-With': 'XMLHttpRequest'
              }
            });
            if(!resp.ok){
              const err = await resp.json().catch(()=>({message:'Server error'}));
              statusEl.textContent = err.message || 'Could not save review.';
              statusEl.className = 'text-red-700 bg-red-50 border border-red-200 rounded p-2';
              statusEl.style.display = '';
              return;
            }
            const json = await resp.json();
            if(json.status !== 'ok'){
              statusEl.textContent = json.message || 'Could not save review.';
              statusEl.className = 'text-red-700 bg-red-50 border border-red-200 rounded p-2';
              statusEl.style.display = '';
              return;
            }

            const r = json.review;
            // build review block
            const block = document.createElement('div');
            block.className = 'border rounded p-4 mb-3';
            const inner = `\n              <div class="flex items-center justify-between mb-2">\n                <div>\n                  <h4 class="font-medium">${escapeHtml(r.title || 'Untitled')}</h4>\n                  <p class="text-xs text-slate-500">by ${escapeHtml(r.user || '')}</p>\n                </div>\n                <div class="text-sm text-slate-600">⭐ ${escapeHtml(String(r.rating || ''))}</div>\n              </div>\n              <p class="text-slate-700 mt-2">${escapeHtml(r.body || '')}</p>\n            `;
            block.innerHTML = inner;
            // insert at top
            if(noReviewsEl){ noReviewsEl.remove(); }
            reviewsList.insertAdjacentElement('afterbegin', block);

            // show success
            statusEl.textContent = 'Review saved.';
            statusEl.className = 'text-green-800 bg-green-50 border border-green-200 rounded p-2';
            statusEl.style.display = '';
            // reset form
            form.reset();
          }catch(err){
            statusEl.textContent = err.message || 'Network error';
            statusEl.className = 'text-red-700 bg-red-50 border border-red-200 rounded p-2';
            statusEl.style.display = '';
          }finally{
            const submitBtn = document.getElementById('review-submit');
            submitBtn.disabled = false;
            submitBtn.classList.remove('opacity-70');
          }
        });

        function escapeHtml(str){
          return String(str)
            .replaceAll('&','&amp;')
            .replaceAll('<','&lt;')
            .replaceAll('>','&gt;')
            .replaceAll('"','&quot;')
            .replaceAll("'","&#39;");
        }
      })();

      // Favorite/Watchlist functionality
      function toggleFavorite(slug) {
        const btn = document.getElementById('favorite-btn');
        const icon = document.getElementById('favorite-icon');
        const text = document.getElementById('favorite-text');
        
        btn.disabled = true;
        
        fetch(`/api/movies/${slug}/favorite/`, {
          method: 'POST',
          headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || '',
            'X-Requested-With': 'XMLHttpRequest',
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.status === 'ok') {
            const isFavorited = data.is_favorited;
            if (isFavorited) {
              icon.textContent = '[LOVED]';
              text.textContent = 'Remove from Watchlist';
              btn.classList.remove('bg-gray-300', 'text-gray-800', 'hover:bg-gray-400');
              btn.classList.add('bg-red-500', 'text-white', 'hover:bg-red-600');
            } else {
              icon.textContent = '[LOVE]';
              text.textContent = 'Add to Watchlist';
              btn.classList.remove('bg-red-500', 'text-white', 'hover:bg-red-600');
              btn.classList.add('bg-gray-300', 'text-gray-800', 'hover:bg-gray-400');
            }
            console.log(data.message);
          } else {
            alert('Error: ' + (data.message || 'Unknown error'));
          }
        })
        .catch(err => {
          console.error('Error:', err);
          alert('Failed to update watchlist');
        })
        .finally(() => {
          btn.disabled = false;
        });
      }
    </script>
    {% else %}
    <div class="bg-blue-50 border border-blue-200 rounded p-4 text-center">
      <p class="text-blue-800 mb-3">Please log in to write a review</p>
      <a href="{% url 'accounts:login' %}" class="inline-block px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">Log In</a>
    </div>
    {% endif %}
  </div>
</div>

{% endblock %}
